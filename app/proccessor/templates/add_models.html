{% extends 'base_site.html' %}

{% block title %}
  Add Models
{% endblock %}

{% block stylesheets %}
  <!-- Bulma -->
  <!-- <link href="{{ url_for('static', filename='vendors/bulma/css/bulma.min.css') }}" rel="stylesheet" /> -->
  {{ super() }}

  <style>
    .form-fields {
      width: max-content;
      margin: auto !important;
      max-width: 100%;
    }
    @media (max-width: 1200px) {
      .custom-col {
        float: unset !important;
      }
    }
    
    textarea {
      resize: vertical;
      min-height: 5rem;
      max-height: 10rem;
    }
    .custom-input,
    .custom-file-input {
      min-height: 5rem !important;
      width: 100%;
      max-width: 100%;
      color: #444;
      padding: 5px;
      background: #fff;
      border-radius: 4px !important;
      height: unset;
    }
    .custom-file-input::file-selector-button {
      margin-right: 20px;
      border: none;
      background: springgreen;
      padding: 10px 20px;
      border-radius: 4px;
      color: #444;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
    }
    
    .custom-file-input:focus::file-selector-button,
    .custom-file-input::file-selector-button:hover {
      background: limegreen;
      color: #fff;
    }
    
    @media (min-width: 1200px) {
      .custom-qualitative-col {
        width: unset !important;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="right_col" role="main">
    <div class="">
      <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
          <div class="x_panel">
            <div class="x_title">
              <h2>Add Classifier Model</h2>
              <ul class="nav navbar-right" style="cursor: pointer;">
                <li>
                  <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                </li>
              </ul>
              <div class="clearfix"></div>
            </div>
            <div class="x_content">
              <div class="container is-widescreen">
                <form class="container" data-parsley-validate method="post" enctype="multipart/form-data">
                  <section class="row justify-content-md-center form-fields">
                    {% if status != 'Initial' %}
                      <input type="text" id="model_id" name="model_id" value="{{ model_id }}" data-status="{{ status }}" hidden />
                    {% endif %}
                    {% if status == 'Create' %}
                      Creating %<p id="progress_bar">0</p>
                    {% else %}
                      {% if status == 'Initial' %}
                        {% for field in form if field.widget.input_type != 'hidden' %}
                          <div class="col col-lg-6 custom-col" style="margin: auto; margin-bottom: 20px; max-width: 100%;">
                            {% if field.widget.input_type == 'file' %}
                              {{ field(class='form-control custom-file-input', placeholder=field.label.text, accept=field.render_kw.accept) }}
                            {% else %}
                              {{ field(class='form-control custom-input', placeholder=field.label.text) }}
                            {% endif %}
                          </div>
                        {% endfor %}
                      {% elif status == 'Second' %}
                        <div class="col col-lg-6 custom-col" style="margin: auto; margin-bottom: 20px; width: 100%;">
                          <label for="target-slector">Columna de Clasificaci√≥n</label>
                          <select name="target" id="target-slector" class="form-control custom-input form-select form-select-lg mb-3" aria-label="Large select example">
                            {% for option in form %}
                              <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                          </select>
                        </div>
                      {% elif status == 'Add' %}
                        <h2>Establezca valores a las posibles variables cualitativas.</h2>
                        {% for col in form %}
                          <input type="text" name="Q-Variable-{{ col.name }}" value="{{ col.name }}" hidden />
                          <div class="col col-lg-6 custom-col custom-qualitative-col" style="margin: auto; margin-bottom: 20px; max-width: 100%;">
                            <label for="">{{ col.name }}</label>
                            {% for var in col.variables %}
                              <div class="col custom-col" style="margin: auto; margin-bottom: 20px; max-width: 100%;">
                                <input class="form-control custom-input" placeholder="Original Value: {{ var }}" type="text" name="{{ col.name }}-{{ var }}" />
                              </div>
                            {% endfor %}
                          </div>
                        {% endfor %}
                      {% endif %}
                    {% endif %}
                  </section>

                  <div class="navbar-right">
                    <button type="submit" id="submit" class="btn btn-default submit" name="{{ status }}">
                      {% if status != 'Add' %}
                        Siguiente
                      {% else %}
                        Crear
                      {% endif %}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block javascripts %}
  {{ super() }}
  <script>
    let interval = 0
    const getProgressPercent = async () => {
      // get
      const progress_bar = document.getElementById('progress_bar')
      const model_id = document.getElementById('model_id')
    
      response = await fetch('http://127.0.0.1:5000/add_model/classifier/percent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: model_id.value
      })
      res = await response.json().then((value) => {
        progress_bar.innerHTML = value[0]
        progress_bar.name = value[0]
        console.log(value[0])
        return value
      })
    
      if (res >= 100) {
        clearInterval(interval)
      }
    }
    
    const add_button = document.getElementById('submit')
    
    const manage_percent = async () => {
      const model_id = document.getElementById('model_id')
      console.log('works')
      console.log(model_id.dataset.status)
      if (model_id && model_id.dataset.status == 'Create') {
        
        interval = setInterval(await getProgressPercent, 3000)
        console.log(interval)
      }
    }
    
    window.addEventListener('DOMContentLoaded', manage_percent)
  </script>
{% endblock %}
